---
layout: post
title: "[THE BEGINNINGS] DoS sobre renegociación SSL/TLS (CVE-2011-1473)"
date: 2011-06-02 10:00:49
categories: [cybersecurity, ssl]
tags: [dos, ssl, tls, cve-2011-1473, old]
---


![](/img/captura_-2011-05-31-a-las-20-10-54.png)

Siempre que hablamos de conexión segura en internet solemos hablar de HTTPS, la diferencia básica entre HTTP y HTTPS es que mediante el protocolo HTTP la información viaja en plano por lo que cualquier intermediario puede husmear nuestra información cosa que no nos interesa, a raíz de la necesidad de mayor seguridad nació HTTPS que añade una capa de cifrado en la comunicación de nuestros datos en la capa de transporte, este cifrado se realiza a través del estándar SSL/TLS. Netscape desarrolló en 1996 SSLv3 que más tarde sirvió para asentar las bases del desarrollo del estándar TLSv1.0, la versión actual es TLSv1.1. En el post de hoy intentaremos explicar como realizar un ataque de denegación de servicio aprovechando que un sitio acepte la renegociación SSL/TLS.

Normalmente cuando alguien desarrolla una web en la que se necesita un nivel de seguridad, ya sea por un login, o por que se realizan tareas delicadas como operaciones bancarias, intranet de una empresa o compras online; es necesario implementar HTTPS, como ya hemos comentado hay diferentes versiones de SSL/TLS y muchas veces las versiones antiguas de los navegadores no son compatibles con las versiones más nuevas de los protocolos de cifrado que HTTPS puede implementar, estas versiones antiguas tienen problemas como niveles de cifrado débiles para la actualidad, menores de 128bits o como en el caso que nos ocupa, tener activada la renegociación de la conexión puede hacer que seamos víctimas de un ataque DoS. En muchas ocasiones esto es permitido por las webs para que sus clientes no tengan problemas de acceso, y puedan navegar aunque estén usan un protocolo de cifrado de hace 10 años. O simplemente por un despiste del desarrollador del sitio.

Para poder explicar como funciona este ataque D.o.S. es importante primero entender como funciona el handshake de HTTPS:
![](http://dan1t0.wordpress.com/wp-content/uploads/2011/05/ssl_intro_fig1.gif)

En la primera parte se establece la versión del protocolo sobre la que se trabajará; se establece un id de sesión; el servidor envía su cipher suite que es una lista de protocolos, versiones y métodos de cifrados que acepta; se decide el método de compresión y se intercambian una serie de valores aleatorios.

* Este paso es opcional, el servidor envía su certificado y la verificación del mismo.

* Este paso va de la mano del paso 2, el cliente responde al servidor con su certificado y la verificación del mismo.

* En este paso se produce el intercambio final de los certificados del cliente y servidor y de sus espeficaciónes correspondientes. A partir de ahora la comunicación cliente-servidor es cifrada.

La base de este ataque se encuentra en el consumo de recursos que le supone al servidor en relación con el cliente, para que nos hagamos una idea un servidor puede negociar entre 150-300 handshakes por segundo (según la potencia del mismo), mientras que un cliente puede solicitar hasta 1000 handshakes por segundo, por lo que no es necesario una botnet ni un súper ordenador para realizar este ataque. Pero para que este ataque surta el efecto deseado el servidor tiene que tener habilitada la renegociación de SSL/TLS.
Como podemos observar, es fácil darse cuenta de por donde van los tiros en este ataque, pedir N peticiones de renegociación de cifrado a nuestro servidor víctima.


Hay varia formas de detectar esta vulnerabilidad, si usamos Nessus existe un plugin (ID53491), aunque también se puede comprobar de forma manual con el comando openssl:

```bash
openssl s_client -connect IP:PUERTO
HEAD / HTTP/1.0
R
RENEGOTIATING
```

Si nos devuelve `RENEGOTIATING` podemos tener claro que el servidor es vulnerable:

![](http://dan1t0.wordpress.com/wp-content/uploads/2011/05/captura_-2011-05-31-a-las-21-44-071.png)

Los chicos de www.thc.org The Hackers Choice< han desarrollado una herramienta para poder explotar esta vulnerabilidad a fondo, la podeis encontrar [aqui](http://www.thc.org/thc-ssl-dos/thc-ssl- dos-1.4.tar.gz).

![](http://dan1t0.wordpress.com/wp-content/uploads/2011/05/captura_-2011-05-31-a-las-21-32-26.png)

Para prevenir este tipo de ataques y otros como MiTM es muy importante tener siempre desactivadas las versiones mas desfasadas de los protocolos de cifrado, tener el software siempre actualizado, las últimas versiones de Apache no son vulnerables y tiene la renegociación SSL desactivada, al igual que las últimas versiones de Microsoft IIS. Por otro lado también es interesante implementar reglas de forma que una determinada IP tenga un número máximo de renegociaciones SSL por segundo, por ejemplo 5, ya que muchas veces como en el caso de querer que los clientes tengan que autenticarse en ciertas paginas con certificados X509 es necesaria tener activada la renegociación.

Es importante comentar que el fallo no está en el protocolo en si, sino en la opción de renegociación de la conexión cifrada.

---
Fuentes:

* [Especificaciones de cifrado](http://www-01.ibm.com/software/webservers/httpservers/doc/v1319/9accipher.htm)
* Protocolo [SSL/TLS](http://es.wikipedia.org/wiki/Transport_Layer_Security)
* Protocolo [HTTPS](http://es.wikipedia.org/wiki/Hypertext_Transfer_Protocol_Secure)
* [www.orchilles.com](http://orchilles.com/2011/03/ssl-renegotiation-dos.html)
* RFC's: RFC2818, RFC4346, RF5746
